<!DOCTYPE html>

<html lang='en-us'>

    <head>

        <meta charset='UTF-8'>
        <title>Title</title>
    </head>
    
    <body>
        
        <div class='container'>
            <div class="row">
                <div class="col-md-12">
                        <div class="jumbotron">
                            <h1 class="text-center">Friend Finder</h1>
                        </div>
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h4 class="panel-title">Friend Finder Survey</h4>
                        </div>
                        <div class="panel-body">
                            <form role="form">
                                <div class="form-group">
                                    <label for="friend-name">Name</label>
                                    <input type="text" class="form-control" id="friend-name">
                                </div>
                                <div class="form-group">
                                    <label for="friend-unique-id">Unique ID</label>
                                    <input type="text" class="form-control" id="friend-unique-id">
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <div class='row'>
                <div class="col-md-12">
                    <div id="questionSection">
                    </div>
                    <div id="answerSection">
                    </div>
                </div>
            </div>
            <div class="row mb-5">
                <div class="col-md-12 btn btn-primary submit">
                    Submit
                </div>
            </div>

            <div class="row">
                <div class="col-md-12">
                    <br>
                </div>
            </div>
        </div>
        
        
        <!-- jQuery -->
        <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js'></script>
    
        <!-- Bootstrap CDN-->

        <link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css'>
        <script src='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js'></script>

    
        <!-- Firebase Reference -->
        <script src='https://www.gstatic.com/firebasejs/live/3.0/firebase.js'></script>

    </div>
    
    <script>
        var answersArray = [0,0,0,0,0,0,0,0,0,0];
        function runQuestionsQuery() {
            $.get("api/questions",function(questions) {
                for(i=0;i<questions.length;i++) {
                    var questionNumber = i + 1;
                    var questionSection = $("<div>");
                        questionSection.addClass("well");
                        questionSection.attr("id", `questionWell-${questionNumber}`);
                        questionSection.attr("data","");
                    $("#questionSection").append(questionSection);

                    // Then display the remaining fields in the HTML (Section Name, Date, URL)
                    $(`#questionWell-${questionNumber}`).append(
                        "<h2><span class='label label-primary'>" + questionNumber + "</span> " + questions[i].question + "</h2>"
                    );

                    $(`#questionWell-${questionNumber}`).append(
                        `<div class="row">
                            <div class="col-md-12">
                                <div class="col-sm-2 col-sm-offset-1 answer_rank btn btn-primary answer answer${questionNumber}-1">1</div>
                                <div class="col-sm-2 answer_rank btn btn-primary answer answer${questionNumber}-2">2</div>
                                <div class="col-sm-2 answer_rank btn btn-primary answer answer${questionNumber}-3">3</div>
                                <div class="col-sm-2 answer_rank btn btn-primary answer answer${questionNumber}-4">4</div>
                                <div class="col-sm-2 answer_rank btn btn-primary answer answer${questionNumber}-5">5</div>
                            </div>
                        </div>`
                    );
                }
            });
        };

        $(".container").on("click",`.answer`,function(value) {
            $(this).parent().parent().parent().attr('data',value.target.innerHTML);
            for (i=0; i < 10; i++) {
                a = $(`#questionWell-${i+1}`).attr("data");
                answersArray.splice(i,1,a); 
            }
            console.log(answersArray);
        });

        $(".container").on("click", ".submit",function(event) {
            event.preventDefault();
            var friend = {
                name: $("#friend-name").val().trim(),
                uniqueId: $("#friend-unique-id").val().trim(),
                quizAnswers: answersArray
            };
            // console.log(friend);
            $.post("/api/surveyResults", friend, function(data) {
                if (data) {
                    console.log("Submitted Successfully");
                } else {
                    console.log("Something went wrong");
                }
                $("#friend-name").val("");
                $("friend-unique-id").val("");
                answersArray = [0,0,0,0,0,0,0,0,0,0];
            });
            $.get("/api/surveyResults", function(data) {
                // console.log(data);
                var otherUserAnswers;
                var currentUserAnswers;
                var differenceArray = [];
                var differenceSum;
                var allDifferencesArray = [];
                for(i=0;i<data.length;i++) {
                    otherUserAnswers = data[i].quizAnswers;
                    currentUserAnswers = friend.quizAnswers;
                    console.log(`otherUserAnswers ${data[i].name} - ${otherUserAnswers}`);
                    console.log(`currentUserAnswers ${friend.name} - ${currentUserAnswers}`);
                    for (j=0;j < currentUserAnswers.length; j++) {
                        differenceArray.push(Math.abs(+currentUserAnswers[j] - +otherUserAnswers[j]))
                    }
                    console.log(`${data[i].name} vs. ${friend.name}`);
                    console.log(differenceArray);
                    differenceSum = differenceArray.reduce(function(a,b) {
                        return a + b;
                    }, 0);
                    console.log(`Difference Sum: ${differenceSum}`);
                    console.log("-----");
                    allDifferencesArray.push(differenceSum)
                    console.log(`All Differences Array: ${allDifferencesArray}`)
                    winningFriend = allDifferencesArray.reduce(function(a,b) {
                        if (a < b) {
                            return a
                        } else if (b < a) {
                            return b
                        } else {
                            return "error"
                        }
                    });
                    console.log(`Winning Difference: ${winningFriend}`)
                    differenceArray = [];
                    differenceSum = 0;
                }

                // data.foreach(function(element) {
                //     console.log(element)
                // });
                // console.log(friend.quizAnswers);
            })
        });
        runQuestionsQuery();
    </script>
    </body>
</html>